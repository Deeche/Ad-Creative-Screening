<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>広告クリエイティブ審査システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-card {
            margin-top: 20px;
            display: none;
        }
        .guidelines-section {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">広告クリエイティブ審査システム</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">広告審査</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/documents">ガイドライン管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4">広告クリエイティブ審査システム</h1>
        
        <!-- ガイドライン表示セクション -->
        <div class="guidelines-section">
            <h3>現在の審査ガイドライン</h3>
            <ul id="guidelines-list" class="list-group">
                <!-- ガイドラインがここに動的に追加されます -->
            </ul>
        </div>

        <!-- タブ -->
        <ul class="nav nav-tabs" id="adTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab">テキスト広告</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="banner-tab" data-bs-toggle="tab" data-bs-target="#banner" type="button" role="tab">バナー広告</button>
            </li>
        </ul>

        <!-- タブコンテンツ -->
        <div class="tab-content" id="adTabsContent">
            <!-- テキスト広告タブ -->
            <div class="tab-pane fade show active" id="text" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">広告テキストの入力</h5>
                        <div class="form-group">
                            <textarea id="adText" class="form-control" rows="4" placeholder="ここに広告テキストを入力してください"></textarea>
                        </div>
                        <button id="submitTextBtn" class="btn btn-primary mt-3">審査開始</button>
                    </div>
                </div>
            </div>

            <!-- バナー広告タブ -->
            <div class="tab-pane fade" id="banner" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">バナー広告のアップロード</h5>
                        <div class="form-group">
                            <input type="file" id="bannerFile" class="form-control" accept=".png,.jpg,.jpeg,.gif">
                            <div id="imagePreview"></div>
                        </div>
                        <button id="submitBannerBtn" class="btn btn-primary mt-3">審査開始</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 結果表示カード -->
        <div id="resultCard" class="card result-card">
            <div class="card-body">
                <h5 class="card-title">審査結果</h5>
                
                <!-- テキスト抽出結果（バナー広告の場合） -->
                <div id="extractedTextSection" style="display: none;">
                    <h6>抽出されたテキスト：</h6>
                    <p id="extractedText" class="border p-2"></p>
                </div>

                <!-- 画像分析結果（バナー広告の場合） -->
                <div id="imageAnalysisSection" style="display: none;">
                    <h6>画像分析結果：</h6>
                    <div class="mb-3">
                        <strong>全体的な印象：</strong>
                        <p id="overallImpression"></p>
                    </div>
                    <div class="mb-3">
                        <strong>視覚要素の評価：</strong>
                        <ul id="visualElements" class="list-group">
                        </ul>
                    </div>
                </div>

                <div class="alert" id="judgementAlert" role="alert">
                    <strong>判定：</strong> <span id="judgement"></span>
                </div>
                <p><strong>理由：</strong> <span id="reason"></span></p>
                <p><strong>リスクスコア：</strong> <span id="riskScore"></span></p>
                
                <!-- 違反項目リスト -->
                <div id="violationsSection" style="display: none;">
                    <h6>違反項目：</h6>
                    <ul id="violationsList" class="list-group">
                    </ul>
                </div>

                <!-- 関連ガイドライン -->
                <div id="guidelinesSection" class="mt-3">
                    <h6>関連するガイドライン：</h6>
                    <ul id="relevantGuidelines" class="list-group">
                    </ul>
                </div>

                <!-- 改善提案 -->
                <div id="improvementsSection" class="mt-3" style="display: none;">
                    <h6>改善提案：</h6>
                    <ul id="improvementsList" class="list-group">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ガイドラインの取得と表示
        fetch('/api/guidelines')
            .then(response => response.json())
            .then(guidelines => {
                const guidelinesList = document.getElementById('guidelines-list');
                guidelines.forEach(guideline => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = guideline;
                    guidelinesList.appendChild(li);
                });
            })
            .catch(error => console.error('Error:', error));

        // 画像プレビュー
        document.getElementById('bannerFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
                }
                reader.readAsDataURL(file);
            }
        });

        // テキスト広告の審査
        document.getElementById('submitTextBtn').addEventListener('click', function() {
            const adText = document.getElementById('adText').value;
            if (!adText) {
                alert('広告テキストを入力してください');
                return;
            }

            this.disabled = true;
            this.textContent = '審査中...';

            fetch('/api/review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: adText,
                    risk_score: 50
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => displayResults(result, false))
            .catch(error => handleError(error))
            .finally(() => {
                this.disabled = false;
                this.textContent = '審査開始';
            });
        });

        // バナー広告の審査
        document.getElementById('submitBannerBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('bannerFile');
            if (!fileInput.files[0]) {
                alert('ファイルを選択してください');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            this.disabled = true;
            this.textContent = '審査中...';

            fetch('/api/analyze_banner', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => displayResults(result, true))
            .catch(error => handleError(error))
            .finally(() => {
                this.disabled = false;
                this.textContent = '審査開始';
            });
        });

        // 結果の表示
        function displayResults(result, isBanner) {
            document.getElementById('resultCard').style.display = 'block';
            
            // エラーチェック
            if (result.error) {
                throw new Error(result.error);
            }

            // バナー広告の場合の追加表示
            if (isBanner) {
                // 抽出テキストの表示
                const extractedTextSection = document.getElementById('extractedTextSection');
                if (result.text_content) {
                    extractedTextSection.style.display = 'block';
                    document.getElementById('extractedText').textContent = result.text_content;
                } else {
                    extractedTextSection.style.display = 'none';
                }

                // 画像分析結果の表示
                const imageAnalysisSection = document.getElementById('imageAnalysisSection');
                if (result.image_analysis) {
                    imageAnalysisSection.style.display = 'block';
                    document.getElementById('overallImpression').textContent = result.image_analysis.overall_impression;
                    
                    const visualElements = document.getElementById('visualElements');
                    visualElements.innerHTML = '';
                    const elements = result.image_analysis.visual_elements;
                    Object.entries(elements).forEach(([key, value]) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = `${key}: ${value}`;
                        visualElements.appendChild(li);
                    });
                } else {
                    imageAnalysisSection.style.display = 'none';
                }

                // テキスト審査結果がある場合はそれを表示
                if (result.text_review) {
                    result = result.text_review;
                }
            }

            // 共通の結果表示
            document.getElementById('judgement').textContent = result.judgement || '判定不可';
            document.getElementById('reason').textContent = result.reason || '理由不明';
            document.getElementById('riskScore').textContent = result.risk_score || 'N/A';

            // 判定結果に応じてアラートの色を変更
            const alertElement = document.getElementById('judgementAlert');
            alertElement.className = 'alert ' + (
                result.judgement === '承認' ? 'alert-success' :
                result.judgement === '要確認' ? 'alert-warning' :
                'alert-danger'
            );

            // 違反項目の表示
            const violationsSection = document.getElementById('violationsSection');
            const violationsList = document.getElementById('violationsList');
            violationsList.innerHTML = '';
            
            if (result.violations && result.violations.length > 0) {
                violationsSection.style.display = 'block';
                result.violations.forEach(violation => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-danger';
                    li.textContent = violation;
                    violationsList.appendChild(li);
                });
            } else {
                violationsSection.style.display = 'none';
            }

            // 関連ガイドラインの表示
            const relevantGuidelines = document.getElementById('relevantGuidelines');
            relevantGuidelines.innerHTML = '';
            if (result.relevant_guidelines) {
                result.relevant_guidelines.forEach(guideline => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = guideline.content;
                    relevantGuidelines.appendChild(li);
                });
            }

            // 改善提案の表示
            const improvementsSection = document.getElementById('improvementsSection');
            const improvementsList = document.getElementById('improvementsList');
            improvementsList.innerHTML = '';

            if (result.improvements && result.improvements.length > 0) {
                improvementsSection.style.display = 'block';
                result.improvements.forEach(improvement => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-info';
                    li.textContent = improvement;
                    improvementsList.appendChild(li);
                });
            } else {
                improvementsSection.style.display = 'none';
            }
        }

        // エラーハンドリング
        function handleError(error) {
            console.error('Error:', error);
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('judgement').textContent = 'エラー';
            document.getElementById('reason').textContent = error.message;
            document.getElementById('riskScore').textContent = 'N/A';
            
            const alertElement = document.getElementById('judgementAlert');
            alertElement.className = 'alert alert-danger';
            
            // エラー時は違反項目と改善提案を非表示
            document.getElementById('violationsSection').style.display = 'none';
            document.getElementById('improvementsSection').style.display = 'none';
            document.getElementById('extractedTextSection').style.display = 'none';
            document.getElementById('imageAnalysisSection').style.display = 'none';
        }
    </script>
</body>
</html>